<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../style/player.css" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="theme-color" content="#000000" />
    <title>캐릭캐릭뮤직체인지</title>
  </head>
  <body>
    <!--ASMR music list-->
    <audio
      class="asmr"
      id="school"
      autoplay
      loop
      src="../assets/school.mp3"
      type="audio/mpeg"
    ></audio>
    <audio
      class="asmr"
      id="rain"
      autoplay
      loop
      src="../assets/rain.mp3"
      type="audio/mpeg"
    ></audio>
    <audio
      class="asmr"
      id="wave"
      autoplay
      loop
      src="../assets/wave.mp3"
      type="audio/mpeg"
    ></audio>
    <!-- Style change sample music -->
    <audio
    id="kpop-sample"
    autoplay
    loop
    src="../assets/Ghost of the wind.mp3"
    type="audio/mpeg">
    </audio>

    <!-- 중앙 정렬용 박스 -->
    <div class="center-box">

    <!--inside of player room-->
    <div class="player-room">
      <img class="sample-room" src="../assets/sample_room.gif">

      <!-- 버튼 감싸는 상자 -->
      <div class="btn-wrap">
        
        <!-- audio input btn -->
        <a href="javascript:openInputPop()">
          <img
            src="../assets/audio_input_btn.png"
            class="room-btn"
            id="input"
          />
        </a>

        <!--ASMR sound btn-->
        <img src="../assets/window1.png"
        id="window" class="room-btn" />

        <!-- drum btn -->
        <a href="javascript:openDrumPop()">
          <img
            src="../assets/drum_btn.png"
            class="room-btn"
            id="drum"
          />
        </a>

        <!--audio effect popup btn-->
        <a href="javascript:openEffectPop()">
          <img
            src="../assets/audio_effect_btn.png"
            class="room-btn"
            id="effect"
          />
        </a>
      </div>
    
    <script>

      /*input popup open*/
      function openInputPop() {
        document.getElementById("input_popup_layer").style.display = "block";
      }
      /*input popup closa*/
      function closeInputPop() {
        document.getElementById("input_popup_layer").style.display = "none";
      }

      /*audio effect control popup open*/
      function openEffectPop() {
        document.getElementById("effect_popup_layer").style.display = "block";
      }
      /*audio effect control popup close*/
      function closeEffectPop() {
        document.getElementById("effect_popup_layer").style.display = "none";
      }

      /*drum popup open*/
      function openDrumPop() {
        document.getElementById("drum_popup_layer").style.display = "block";
      }
      /*drum popup close*/
      function closeDrumPop() {
        document.getElementById("drum_popup_layer").style.display = "none";
      }

      var target = document.querySelectorAll('.btn_open');
      var targetID;
    
      // 팝업 열기
      for(var i = 0; i < target.length; i++){
        target[i].addEventListener('click', function(){
          targetID = this.getAttribute('href');
          document.querySelector(targetID).style.display = 'block';
        });
      }
      
      // 팝업 닫기
      for(var j = 0; j < target.length; j++){
        btnPopClose[j].addEventListener('click', function(){
          this.parentNode.parentNode.style.display = 'none';
        });
      }
    </script>
      
      <!--layer popup area-->

      <!-- 입력 팝업 -->
      <div class="popup_layer" id="input_popup_layer" style="display: none">
        <div class="input_popup_box">
          <div style="float: top">
            <a href="javascript:closeInputPop();">
              <img
                src="../assets/x.jpg"
                class="m_header-banner-close"
                width="30px"
                height="30px"
            /></a>
          </div>
          <!--layer input popup content area-->
          <div class="popup_cont">
            <div class="filebox">
              <label for="file">mid-file 선택
              <input type="file" id="file">
              </label> 
              <input class="upload-name" value="첨부파일" placeholder="첨부파일">
           </div>
          </div>
        </div>
      </div>

      <!-- 사운드이펙트 팝업-->
      <div class="popup_layer" id="effect_popup_layer" style="display: none">
        <div class="popup_box">
          <div style="height: 10px; width: 375px; float: top">
            <a href="javascript:closeEffectPop();"
              ><img
                src="../assets/x.jpg"
                class="m_header-banner-close"
                width="30px"
                height="30px"
            /></a>
          </div>
          <!--layer popup content area-->
          <div class="popup_cont">
            <h5>EFFECT CONTROL</h5>
            <div class="control_panel_layer">
              <div class="control_div">
                <label class="panel_label">VOLUME</label>
                <input
                  class="panel_bar"
                  type="range"
                  id="volume_slider"
                  min="0"
                  max="100"
                  value="50"
                  onclick="volume_control(event)"
                />
              </div>
              <div class="control_div">
                <label class="panel_label">BPM</label>
                <input
                  class="panel_bar"
                  type="range"
                  id="bpm_slider"
                  min="0"
                  max="100"
                  value="50"
                  onclick="bpm_control(event)"
                />
              </div>
              <div class="control_div">
                <label class="panel_label">REVERB</label>
                <input
                  class="panel_bar"
                  type="range"
                  id="reverb_slider"
                  min="0"
                  max="100"
                  value="50"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 드럼 팝업 -->
      <div class="popup_layer" id="drum_popup_layer" style="display: none">
        <div class="drum_popup_box">
          <div style="float: top">
            <a href="javascript:closeDrumPop();"
              ><img
                src="../assets/x.jpg"
                class="m_header-banner-close"
                width="30px"
                height="30px"
            /></a>
          </div>
          <!--layer input popup content area-->
          <div class="popup_cont">
  
          </div>
        </div>
      </div>      

      <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
      <script type="text/javascript">

        // 인풋 팝업 파일명 표시
        $("#file").on('change',function(){
          var fileName = $("#file").val();
          $(".upload-name").val(fileName);
        });

        /*창문 click 시 창문 그래픽 및 ASMR 음원 변경*/
        $(function () {
          let num = 0;
          let imageName = ["1", "2", "3", "4"];
          var audio1 = document.getElementById("school");
          var audio2 = document.getElementById("rain");
          var audio3 = document.getElementById("wave");
          $("#window").click(function () {
            if (num == 0) {
              audio3.pause();
              audio2.pause();
              audio1.play();
              num++;
            } else if (num == 1) {
              audio1.pause();
              audio3.pause();
              audio2.play();
              num++;
            } else if (num == 2) {
              audio1.pause();
              audio2.pause();
              audio3.play();
              num++;
            } else {
              audio1.pause();
              audio2.pause();
              audio3.pause();
              num = 0;
            }
            $(this).attr("src", "../assets/window" + imageName[num] + ".PNG");
            audio.puase();
            audio.play();
          });
        });

        /*audio volume control - 일괄 조정 가능하도록 추후 코드 수정*/
        function volume_control(){
          const audio1 = document.getElementById("school");
          const audio2 = document.getElementById("rain");
          const audio3 = document.getElementById("wave");
          const asrmAudioVolume = document.getElementById("volume_slider");
          audio1.volume = asrmAudioVolume.value/100;
          audio2.volume = asrmAudioVolume.value/100;
          audio3.volume = asrmAudioVolume.value/100;
        }
      </script>

    <!-- pixel audio visualization-->
    <div style="margin: 1em">
        <canvas id="canvas" width="720"></canvas>
    </div>

      <!--player room outside-->

    </div>
        <div class="bottom-wrap">
          <!--style 선택 dropbox-->
          <div class="style-dropdown">
            <button class="style-dropbtn">
              <span class="style-dropbtn_icon">more_horiz</span>
              STYLE
            </button>
            <div class="style-dropdown-content">
              <a href="#">basic</a>
              <a href="#">mellow</a>
              <a href="#">sad</a>
            </div>
          </div>
    
          <!--bpm 선택 dropbox-->
          <div class="style-dropdown">
            <button class="style-dropbtn">
              <span class="style-dropbtn_icon">more_horiz</span>
              BPM
            </button>
            <div class="style-dropdown-content">
              <a href="#">80</a>
              <a href="#">100</a>
              <a href="#">120</a>
            </div>
          </div>

        <!--style transfer output music 재생바-->
         <link href='https://fonts.googleapis.com/css?family=Roboto:100' rel='stylesheet' type='text/css'>
         <div class="mp3-player">
           <div class="player">
                <div class="playarea">
                  <div class="play" id="play-img" onclick="musicControl()">
                    <script>
                      var playMode = 0;
                      /* 재생 */
                      function play(){
                        var audio4 = document.getElementById("kpop-sample");
                        document.getElementById("kpop-sample").volume =0.1;
                        audio4.play();
                        playMode==1
                      }
                      /* 일시정지 */
                      function pause(){
                        var audio4 = document.getElementById("kpop-sample");
                        audio4.pause();
                        playMode==0
                      }
                      /* music mode change */
                      function musicControl(){
                        if (playMode==0){
                          play();
                          playMode=1;
                        } else {
                          pause();
                          playMode=0;
                        }
                      }
                      /* 버튼 이미지 변경 */
                      function imgControl(){
                        document.getElementById("play-img").src="../assets/pause."
                      }
                    </script>
                  </div>
                  <div class="pause" onclick="pause()">
                  </div>
                  <div class="soundControl" id = "volume-Control">
                    <input
                      class="mp3-bar"
                      type="range"
                      id="volume-slider"
                      min="0"
                      max="100"
                      value="50"
                    />
                  <script>
                    // volume control
                      const audio = document.getElementById('kpop-sample');
                      const audioVolume = document.getElementById("volume-slider");
                      audioVolume.addEventListener("change", function(e) {
                        audio.volume = this.value/100;
                      })
                      function mute(){
                          
                      }
                  </script>
                </div>
              </div>
            </div>
          </div> 

        </div>


    </div>
  <!-- 오디오 비주얼라이제이션 -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function getPos(Hz, minHz, maxHz, max) {
        if (Hz > minHz) {
          var posMin = Math.log10(minHz) * max;
          return (
            ((Math.log10(Hz) - Math.log10(minHz)) * max) /
            (Math.log10(maxHz) - Math.log10(minHz))
          );
        } else {
          return 0;
        }
      }

      function getFFTbars(fft, barCount) {
        var minHz =
          arguments.length > 2 && arguments[2] !== undefined
            ? arguments[2]
            : 20;
        var maxHz =
          arguments.length > 3 && arguments[3] !== undefined
            ? arguments[3]
            : 12000;
        var dataArray = new Float32Array(bufferLength);
        fft.getFloatFrequencyData(dataArray);
        var pos;
        var out = [];

        for (i in dataArray) {
          pos = Math.round(
            getPos((i * 24000) / dataArray.length, minHz, maxHz, barCount)
          );
          if (pos < barCount)
            if (!out[pos] || out[pos] < dataArray[i]) out[pos] = dataArray[i];
        }

        for (i = 0; i < barCount; i++) {
          if (!out[i]) {
            var prevIndex = void 0,
              prevValue = void 0;

            if ((prevIndex = i - 1) < 0) {
              prevIndex = 0;
              prevValue = 0;
            } else {
              prevValue = out[prevIndex];
            }

            var nextIndex = void 0,
              nextValue = void 0;

            for (var k = i; k < barCount; k++) {
              if (out[k]) {
                nextIndex = k;
                nextValue = out[k];
                break;
              }
            }

            if (!nextIndex) {
              nextIndex = barCount - 1;
              nextValue = 0;
            }

            out[i] =
              prevValue + (nextValue - prevValue) / (nextIndex - prevIndex);
          }
        }

        return out;
      }

      function draw() {
        var bars = getFFTbars(analyser, 72);
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.fillStyle = "rgb(255, 255, 255)";
        canvasCtx.beginPath();

        for (i in bars) {
          canvasCtx.rect(
            i * 10,
            canvas.height - ((bars[i] + 64) * canvas.height) / 64,
            8,
            canvas.height
          );
        }

        canvasCtx.fill();
      }

      var canvas,
        canvasCtx,
        audioCtx,
        source,
        analyser,
        bufferLength,
        dataArray,
        gainNode;
      var initialized = false;
      audio.addEventListener("play", function () {
        if (!initialized) {
          canvas = document.getElementById("canvas");
          canvasCtx = canvas.getContext("2d");
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          source = audioCtx.createMediaElementSource(audio);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 4096;
          bufferLength = analyser.frequencyBinCount;
          dataArray = new Float32Array(bufferLength);
          gainNode = audioCtx.createGain();
          source.connect(analyser);
          source.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          setInterval(draw, 16);
          initialized = true;
        }
      });
    });
  </script>
  </body>
</html>
