<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../static/player.css" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <meta name="theme-color" content="#000000" />
    <script
      type="text/javascript"
      src="https://unpkg.com/tone@13.4.9/build/Tone.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@tonejs/midi"
    ></script>
    <title>캐릭캐릭뮤직체인지</title>
  </head>
  <body>
    <!--ASMR music list-->
    <audio
      class="asmr"
      id="school"
      loop
      src="../static/assets/asmr-nightcity.mp3"
      type="audio/mpeg"
    ></audio>
    <audio
      class="asmr"
      id="rain"
      loop
      src="../static/assets/asmr-rain.wav"
      type="audio/mpeg"
    ></audio>
    <audio
      class="asmr"
      id="wave"
      loop
      src="../static/assets/wave.mp3"
      type="audio/mpeg"
    ></audio>
    <!-- Style change sample music -->
    <audio
    id="kpop-sample"
    loop
    src="../static/assets/Ghost of the Wind.mp3"
    type="audio/mpeg">
    </audio>
    <!-- drum preset -->
    <audio
      id="drum-60-bpm"
      loop
      src="../static/assets/drum-60-bpm.mp3"
      type="audio/mpeg"
    ></audio>
    <audio
      id="drum-80-bpm"
      loop
      src="../static/assets/drum-80-bpm.mp3"
      type="audio/mpeg"
    ></audio>
    <audio
      id="drum-100-bpm"
      loop
      src="../static/assets/drum-100-bpm.mp3"
      type="audio/mpeg"
   ></audio>

    <!-- 중앙 정렬용 박스 -->
    <div class="center-box">
      <!--layer popup area-->
      <div class="modal">
        <!-- 입력 팝업 -->
        <div
          class="popup_layer"
          id="input_popup_layer"
          style="height: 100px; width: 200px; display: none"
        >
          <div class="input_popup_box">
            <div style="float: top">
              <a href="javascript:closeInputPop();">
                <img
                  src="../static/assets/x.jpg"
                  class="m_header-banner-close"
                  width="30px"
                  height="30px"
              /></a>
            </div>
            <!--layer input popup content area-->
            <div class="popup_cont">
              <div class="filebox">
                <div class="container">
                  <form
                    method="post"
<<<<<<< Updated upstream
                    action="http://localhost:5000/upload"
=======
                    action="http://localhost:5000/output"
>>>>>>> Stashed changes
                    enctype="multipart/form-data"
                  >
                    <input type="file" name="file" />
                    <input type="submit" value="submit" />
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 사운드이펙트 팝업-->
        <div class="popup_layer" id="effect_popup_layer" style="display: none">
          <div class="effect_popup_box">
            <div style="height: 10px; width: 375px; float: top">
              <a href="javascript:closeEffectPop();"
                ><img
                  src="../static/assets/x.jpg"
                  class="m_header-banner-close"
                  width="30px"
                  height="30px"
              /></a>
            </div>
            <!--layer popup content area-->
            <div class="popup_cont">
              <h5>EFFECT CONTROL</h5>
              <div class="control_panel_layer">
                <div class="control_div">
                  <label class="panel_label">MUSIC</label>
                  <input
                    class="panel_bar"
                    type="range"
                    id="music-volume-slider"
                    min="0"
                    max="100"
                    value="50"
                    onclick="music_volume()"
                  />
                </div>
                <div class="control_div">
                  <label class="panel_label">DRUM</label>
                  <input
                    class="panel_bar"
                    type="range"
                    id="drum-volume-slider"
                    min="0"
                    max="100"
                    value="50"
                    onclick="drum_volume(event)"
                  />
                </div>
                <div class="control_div">
                  <label class="panel_label">ASMR</label>
                  <input
                    class="panel_bar"
                    type="range"
                    id="asmr-volume-slider"
                    min="0"
                    max="100"
                    value="50"
                    onclick="asmr_volume()"
                  />
                </div>
                <div class="control_div">
                  <label class="panel_label">REVERB</label>
                  <input
                    class="panel_bar"
                    type="range"
                    id="reverb-slider"
                    min="0"
                    max="100"
                    value="50"
                    onclick="reverb_control"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 드럼 팝업 -->
        <div
          class="popup_layer"
          id="drum_popup_layer"
          style="height: 100px; width: 200px; display: none"
        >
          <div class="drum_popup_box">
            <div style="float: top">
              <a href="javascript:closeDrumPop();"
                ><img
                  src="../static/assets/x.jpg"
                  class="m_header-banner-close"
                  width="30px"
                  height="30px"
              /></a>
            </div>
            <!--layer input popup content area-->
            <div class="popup_cont">
              <div class="drum-btn-wrap">
                <button class="drum-btn">1</button>
                <button class="drum-btn">2</button>
                <button class="drum-btn">3</button>
                <button class="drum-btn">4</button>
                <button class="drum-btn">5</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--inside of player room-->
      <div class="player-room">
        <img class="sample-room" src="../static/assets/sample_room.gif" />

        <!-- button wrap -->
        <div class="btn-wrap">
          <!-- audio input btn -->
          <a href="javascript:openInputPop()">
            <img
              src="../static/assets/audio_input_btn.png"
              class="room-btn"
              id="input"
            />
          </a>

          <!--ASMR sound btn-->
          <img
            src="../static/assets/window1.png"
            id="window"
            class="room-btn"
          />

          <!-- drum btn -->
          <a href="javascript:openDrumPop()">
            <img
              src="../static/assets/drum_btn.png"
              class="room-btn"
              id="drum"
            />
          </a>

          <!--audio effect popup btn-->
          <a href="javascript:openEffectPop()">  
            <img
              src="../static/assets/audio_effect_btn.png"
              class="room-btn"
              id="effect"
            />
          </a>
        </div>

        <script>
          /*input popup open*/
          function openInputPop() {
            document.getElementById("input_popup_layer").style.display =
              "block";
          }
          /*input popup closa*/
          function closeInputPop() {
            document.getElementById("input_popup_layer").style.display = "none";
          }

          /*audio effect control popup open*/
          function openEffectPop() {
            document.getElementById("effect_popup_layer").style.display =
              "block";
          }
          /*audio effect control popup close*/
          function closeEffectPop() {
            document.getElementById("effect_popup_layer").style.display =
              "none";
          }

          /*drum popup open*/
          function openDrumPop() {
            document.getElementById("drum_popup_layer").style.display = "block";
          }
          /*drum popup close*/
          function closeDrumPop() {
            document.getElementById("drum_popup_layer").style.display = "none";
          }

          var target = document.querySelectorAll(".btn_open");
          var targetID;

          // 팝업 열기
          for (var i = 0; i < target.length; i++) {
            target[i].addEventListener("click", function () {
              targetID = this.getAttribute("href");
              document.querySelector(targetID).style.display = "block";
            });
          }

          // 팝업 닫기
          for (var j = 0; j < target.length; j++) {
            btnPopClose[j].addEventListener("click", function () {
              this.parentNode.parentNode.style.display = "none";
            });
          }
        </script>
        <script src="http://reverbjs.org/reverb.js"></script>
        <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script type="text/javascript">
          // 인풋 팝업 파일명 표시
          $("#file").on("change", function () {
            var fileName = $("#file").val();
            $(".upload-name").val(fileName);
          });

          /*창문 click 시 창문 그래픽 및 ASMR 음원 변경*/
          $(function () {
            let num = 0;
            let imageName = ["1", "2", "3", "4"];
            var audio1 = document.getElementById("school");
            var audio2 = document.getElementById("rain");
            var audio3 = document.getElementById("wave");
            $("#window").click(function () {
              if (num == 0) {
                audio3.pause();
                audio2.pause();
                audio1.play();
                num++;
              } else if (num == 1) {
                audio1.pause();
                audio3.pause();
                audio2.play();
                num++;
              } else if (num == 2) {
                audio1.pause();
                audio2.pause();
                audio3.play();
                num++;
              } else {
                audio1.pause();
                audio2.pause();
                audio3.pause();
                num = 0;
              }
              $(this).attr(
                "src",
                "../static/assets/window" + imageName[num] + ".PNG"
              );
              audio.puase();
              audio.play();
            });
          });

          /*audio volume control - 일괄 조정 가능하도록 추후 코드 수정*/
          function asmr_volume() {
            const audio1 = document.getElementById("school");
            const audio2 = document.getElementById("rain");
            const audio3 = document.getElementById("wave");
            const asrmAudioVolume =
              document.getElementById("asmr-volume-slider");
            audio1.volume = asrmAudioVolume.value / 100;
            audio2.volume = asrmAudioVolume.value / 100;
            audio3.volume = asrmAudioVolume.value / 100;
          }

          function music_volume() {
            const audio = document.getElementById("kpop-sample");
            const musicAudioVolume = document.getElementById(
              "music-volume-slider"
            );
            audio.volume = musicAudioVolume.value / 100;
          }

          function drum_volume() {
            const audio = document.getElementById("drum-80-bpm");
            const drumAudioVolume =
              document.getElementById("drum-volume-slider");
            audio.volume = drumAudioVolume.value / 100;
          }
          
          function reverb_control() {
            const reverbRate = document.getElementById("reverb-slider");
            Tone.Reverb.decay(reverbRate/80);
          }
        </script>

        <!-- pixel audio visualization-->
        <div style="margin: 1em">
          <canvas id="canvas" width="720"></canvas>
        </div>

        <!--player room outside-->
      </div>
      <div class="bottom-wrap">
        <!--style 선택 dropbox-->
        <div class="style-dropdown">
          <button class="style-dropbtn">
            <span class="style-dropbtn_icon">more_horiz</span>
            STYLE
          </button>
          <div class="style-dropdown-content">
            <option value="basic"
            class="stylebtn"
            onclick="setStyle(this.value)"
            >basic</a>
            <option value= "mellow"
            class="stylebtn"
            onclick= "setStyle(this.value)"
            >mellow</a>
            <option value= "sad"
            class="stylebtn"
            onclick="setStyle(this.value)"
            >sad</a>
          </div>
        </div>

        <!--bpm 선택 dropbox-->
        <div class="style-dropdown">
          <button class="style-dropbtn">
            <div class="bpm-text-wrap">
              <span class="style-dropbtn_icon">more_horiz</span>
              BPM
              <span id="bpm">0</span>
            </div>
          </button>
          <div class="style-dropdown-content">
            <option value="60" class="bpmbtn" onclick="setBpm(this.value); changeDrum(this.value)">60</option>
            <option value="80" class="bpmbtn" onclick="setBpm(this.value); changeDrum(this.value)">80</option>
            <option value="100" class="bpmbtn" onclick="setBpm(this.value); changeDrum(this.value)">100</option>
          </div>
        </div>
        <tone-content>
          <tone-play-toggle>
            <button id="target">start</button>
          </tone-play-toggle>
        </tone-content>

        <script>
          var buffer = new Tone.Buffer("../static/assets/output-sample.mid", function(){
            //the buffer is now available.
            console.log(buffer)
            var buff = buffer.get();
          });

          const reverb = new Tone.Reverb();

          const player = new Tone.Player({
            url: buffer,
            loop: true,
            volume: 6,
          }).connect(reverb);

          ui({
            parent: document.querySelector("#content"),
            tone: reverb
          });

          // bind the interface
          document.querySelector("tone-play-toggle").addEventListener("start", () => player.start());
          document.querySelector("tone-play-toggle").addEventListener("stop", () => player.stop());

        </script>

      <script>

        //초기 설정
        var drumAudio_60 = document.getElementById("drum-60-bpm");
        var drumAudio_80 = document.getElementById("drum-80-bpm");
        var drumAudio_100 = document.getElementById("drum-100-bpm");
        var asrmAudioVolume = document.getElementById("asmr-volume-slider");  
        drumAudio_60.volume = 0.1;
        drumAudio_80.volume = 0.1;
        drumAudio_100.volume = 0.1;

        setBpm(80);

          // bpm change
          function setBpm(bpm) {
            var target_bpm = Number(bpm);
            Tone.Transport.bpm.value = target_bpm;
            document.getElementById("bpm").textContent =
            target_bpm;

            var exec = require('child_process').exec, child;            
          }
          
          // bpm에 맞춰서 drum 바꾸는 함수
          function changeDrum(bpm) {
            if (nowbpm != selectbpm){ //현재 bpm과 선택한 bpm이 다를 떄
              if (bpm==60) {
                console.log("드럼 테스트")
                // drum change
                drumAudio_80.pause(); // 일시 정지
                drumAudio_80.currentTime = 0;
                drumAudio_100.pause(); // 일시 정지
                drumAudio_100.currentTime = 0;
                drumAudio_60.play();
              } else if (bpm==80) {
                drumAudio_60.pause(); // 일시 정지
                drumAudio_60.currentTime = 0;
                drumAudio_100.pause(); // 일시 정지
                drumAudio_100.currentTime = 0;
                drumAudio_80.play();
              } else { //bpm==100
                drumAudio_60.pause(); // 일시 정지
                drumAudio_60.currentTime = 0;
                drumAudio_80.pause(); // 일시 정지
                drumAudio_80.currentTime = 0;
                drumAudio_100.play();
              }
            }
          }

          function setStyle(style) {
            var style = style;
          }
        </script>

        <!-- 임시 bpm 조정 -->
        <script
        type="text/javascript"
        src="//www.midijs.net/lib/midi.js"
        >
        MIDIjs.play("../static/output/output_midi.mid") // 추후 경로 output으로 수정
        </script>
        <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>
        <midi-player
          src="../static/output/output_midi.mid"
          sound-font
          visualizer="#myVisualizer"
        >
        </midi-player>
        </script>

        <form onsubmit="fetchMidi(this.url.value); return false;"
        ></form>
        <div id="FileDrop">
        <div id="Text"></div>
        <input type="file" id="test-file" accept="audio/midi" />
        </div>
        <tone-play-toggle disabled></tone-play-toggle>
        <span><tone-button id="rewind"></tone-button></span>
        <span id="position">0:0</span>
        <span id="ticks">Ticks:</span>

        <!--style transfer output music 재생바-->
        <link
          href="https://fonts.googleapis.com/css?family=Roboto:100"
          rel="stylesheet"
          type="text/css"
        />
        <div class="mp3-player">
          <div class="player">
            <div class="playarea">
              <div class="play" id="play-img" onclick="musicControl()">
                <script>
                  var playMode = 0;
                  /* 재생 */
                  function play() {
                    var audio4 = document.getElementById("kpop-sample");
                    document.getElementById("kpop-sample").volume = 0.1;
                    audio4.play();
                    playMode == 1;
                  }
                  /* 일시정지 */
                  function pause() {
                    var audio4 = document.getElementById("kpop-sample");
                    audio4.pause();
                    playMode == 0;
                  }
                  /* music mode change */
                  function musicControl() {
                    if (playMode == 0) {
                      play();
                      playMode = 1;
                    } else {
                      pause();
                      playMode = 0;
                    }
                  }
                  /* 버튼 이미지 변경 */
                  function imgControl() {
                    document.getElementById("play-img").src =
                      "../static/assets/pause.";
                  }
                </script>
              </div>
              <div class="pause" onclick="pause()"></div>
              <div class="soundControl" id="volume-Control" display="none">
                <script>
                  // volume control 코드 삭제하면 오디오 비주얼라이제이션 안됨 (왜?)
                  const audio = document.getElementById("kpop-sample");
                  const audioVolume = document.getElementById("volume-slider");
                  audioVolume.addEventListener("change", function (e) {
                    audio.volume = this.value / 100;
                  });
                  function mute() {}
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 오디오 비주얼라이제이션 -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        function getPos(Hz, minHz, maxHz, max) {
          if (Hz > minHz) {
            var posMin = Math.log10(minHz) * max;
            return (
              ((Math.log10(Hz) - Math.log10(minHz)) * max) /
              (Math.log10(maxHz) - Math.log10(minHz))
            );
          } else {
            return 0;
          }
        }

        function getFFTbars(fft, barCount) {
          var minHz =
            arguments.length > 2 && arguments[2] !== undefined
              ? arguments[2]
              : 20;
          var maxHz =
            arguments.length > 3 && arguments[3] !== undefined
              ? arguments[3]
              : 12000;
          var dataArray = new Float32Array(bufferLength);
          fft.getFloatFrequencyData(dataArray);
          var pos;
          var out = [];

          for (i in dataArray) {
            pos = Math.round(
              getPos((i * 24000) / dataArray.length, minHz, maxHz, barCount)
            );
            if (pos < barCount)
              if (!out[pos] || out[pos] < dataArray[i]) out[pos] = dataArray[i];
          }

          for (i = 0; i < barCount; i++) {
            if (!out[i]) {
              var prevIndex = void 0,
                prevValue = void 0;

              if ((prevIndex = i - 1) < 0) {
                prevIndex = 0;
                prevValue = 0;
              } else {
                prevValue = out[prevIndex];
              }

              var nextIndex = void 0,
                nextValue = void 0;

              for (var k = i; k < barCount; k++) {
                if (out[k]) {
                  nextIndex = k;
                  nextValue = out[k];
                  break;
                }
              }

              if (!nextIndex) {
                nextIndex = barCount - 1;
                nextValue = 0;
              }

              out[i] =
                prevValue + (nextValue - prevValue) / (nextIndex - prevIndex);
            }
          }

          return out;
        }

        function draw() {
          var bars = getFFTbars(analyser, 72);
          canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
          canvasCtx.fillStyle = "rgb(255, 255, 255)";
          canvasCtx.beginPath();

          for (i in bars) {
            canvasCtx.rect(
              i * 10,
              canvas.height - ((bars[i] + 64) * canvas.height) / 64,
              8,
              canvas.height
            );
          }

          canvasCtx.fill();
        }

        var canvas,
          canvasCtx,
          audioCtx,
          source,
          analyser,
          bufferLength,
          dataArray,
          gainNode;
        var initialized = false;
        audio.addEventListener("play", function () {
          if (!initialized) {
            canvas = document.getElementById("canvas");
            canvasCtx = canvas.getContext("2d");
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaElementSource(audio);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 4096;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Float32Array(bufferLength);
            gainNode = audioCtx.createGain();
            source.connect(analyser);
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            setInterval(draw, 16);
            initialized = true;
          }
        });
      });
    </script>

    <!-- Tone.js 스크립트 코드 -->
    <script type="text/javascript">
      var CW = CW || {};

      CW.tempoOffset = 0; //a property to manage the global changes to tempo

      if (
        !(window.File && window.FileReader && window.FileList && window.Blob)
      ) {
        document.querySelector("#FileDrop #Text").textContent =
          "Reading files not supported by this browser";
      } else {
        const fileDrop = document.querySelector("#FileDrop");
        fileDrop.addEventListener("dragenter", () =>
          fileDrop.classList.add("Hover")
        );
        fileDrop.addEventListener("dragleave", () =>
          fileDrop.classList.remove("Hover")
        );
        fileDrop.addEventListener("drop", () =>
          fileDrop.classList.remove("Hover")
        );
        document
          .querySelector("#FileDrop input")
          .addEventListener("change", (e) => {
            const files = e.target.files;
            if (files.length > 0) {
              const file = files[0];
              document.querySelector("#FileDrop #Text").textContent = file.name;
              readFile(file);
            }
          });
      }

      function readFile(file) {
        //handle errors like 404, other screwups; also only accept midi
        const reader = new FileReader();
        reader.onload = function (e) {
          const midi = new Midi(e.target.result);
          const useableMidiObject = parseMidi(midi);
          makeSong(useableMidiObject);
        };
        reader.readAsArrayBuffer(file);
      }

      function fetchMidi(myURL) {
        Midi.fromUrl(myURL).then((midi) => {
          const useableMidiObject = parseMidi(midi);
          makeSong(useableMidiObject);
        });
      }

      //************** parse data from midi file or url into useable midi object ********************
      function parseMidi(midi) {
        if (midi.header) {
          const midiJSON = JSON.stringify(midi, undefined, null);
          const parsedMidiObject = JSON.parse(midiJSON);
          return parsedMidiObject;
        } else {
          alert("Something went wrong when parsing your midi file");
          location.reload();
        }
      }

      function setupPlayer(midi) {
        document.querySelector("#ResultsText").value = JSON.stringify(
          midi,
          undefined,
          2
        );
        document.querySelector("tone-play-toggle").removeAttribute("disabled");
        document.addEventListener("keydown", assignKeys);
      }

      //************** Put midi data into Tone.Parts ********************

      function makeSong(midi) {
        Tone.Transport.PPQ = midi.header.ppq;
        const numofVoices = midi.tracks.length;
        const synths = [];

        //************** Tell Transport about Time Signature changes  ********************
        for (let i = 0; i < midi.header.timeSignatures.length; i++) {
          Tone.Transport.schedule(function (time) {
            Tone.Transport.timeSignature =
              midi.header.timeSignatures[i].timeSignature;
            console.log(
              midi.header.timeSignatures[i].timeSignature,
              Tone.Transport.timeSignature,
              Tone.Transport.position
            );
          }, midi.header.timeSignatures[i].ticks + "i");
        }

        //************** Tell Transport about bpm changes  ********************
        for (let i = 0; i < midi.header.tempos.length; i++) {
          Tone.Transport.schedule(function (time) {
            Tone.Transport.bpm.value =
              midi.header.tempos[i].bpm + CW.tempoOffset;
          }, midi.header.tempos[i].ticks + "i");
        }

        //************ Change time from seconds to ticks in each part  *************
        for (let i = 0; i < numofVoices; i++) {
          midi.tracks[i].notes.forEach((note) => {
            note.time = note.ticks + "i";
          });
        }

        //************** Create Synths and Parts, one for each track  ********************
        for (let i = 0; i < numofVoices; i++) {
          synths[i] = new Tone.PolySynth().toMaster();

          var part = new Tone.Part(function (time, value) {
            synths[i].triggerAttackRelease(
              value.name,
              value.duration,
              time,
              value.velocity
            );
          }, midi.tracks[i].notes).start();
        }

        setupPlayer(midi); //only does this once makeSong finished
      }

      //************** Set up position & BPM indicators  ********************

      Tone.Transport.scheduleRepeat(function (time) {
        showPosition();
        document.getElementById("ticks").textContent =
          "Ticks: " + Tone.Transport.ticks;
      }, "8n");

      function showPosition() {
        //need to coordinate this with latencyHint in setupPlayer if I want accuracy
        var myPos = Tone.Transport.position;
        var posArray = myPos.split(/\D+/); // split based on non-digits
        var myBar = Number(posArray[0]) + 1; //first element, converted to number, then increased
        var myBeat = Number(posArray[1]) + 1;
        document.getElementById("position").textContent = myBar + ":" + myBeat;
      }

      //************** Set up buttons  ********************
      //******* Everything below here is cosmetic  ********

      function changeTempo(dir) {
        switch (dir) {
          case "up" || "ArrowUp" || 38:
            Tone.Transport.bpm.value = Tone.Transport.bpm.value + 1.01;
            CW.tempoOffset = CW.tempoOffset + 1.01;
            break;

          case "dn" || "ArrowDown" || 40:
            Tone.Transport.bpm.value = Tone.Transport.bpm.value - 1.01;
            CW.tempoOffset = CW.tempoOffset - 1.01;
            break;

          case "reset":
            if (Tone.Transport.state === "started") {
              const baseTempo = Tone.Transport.bpm.value - CW.tempoOffset;
              Tone.Transport.bpm.value = baseTempo;
            }
            CW.tempoOffset = 0;
            break;
        }
      }

      function assignKeys(event) {
        var key = event.key || event.keyCode;

        if (key === "ArrowUp" || key === 38) {
          event.preventDefault();
          changeTempo("up");
        }

        if (key === "ArrowDown" || key === 40) {
          event.preventDefault();
          changeTempo("dn");
        }
      }

      document
        .querySelector("tone-play-toggle")
        .addEventListener("change", (e) => {
          if (e.detail) {
            Tone.Transport.start();
          } else {
            Tone.Transport.pause();
          }
        });

      document.querySelector("#rewind").label = "REWIND";
      document.querySelector("#rewind").addEventListener("click", (e) => {
        if (Tone.Transport.state === "started") {
          Tone.Transport.stop();
          Tone.Transport.position = "0:0:0";
          Tone.Transport.start();
        } else {
          Tone.Transport.stop();
          Tone.Transport.position = "0:0:0";
        }
      });
    </script>
  </body>
</html>
